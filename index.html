<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ABSENSI BUMDES AMJ</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&family=Orbitron:wght@400;700;900&display=swap');
        
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: #f0f2f5; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }

        .masjid-header {
            position: fixed; top: 0; left: 0; width: 100%; height: 100px;
            background: #000; z-index: 2000;
            display: flex; flex-direction: column; align-items: center;
            border-bottom: 4px solid #b59b00;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }
        
        .running-text { width: 100%; background: #111; color: #ffcc00; font-size: 13px; font-weight: 800; padding: 8px 0; border-bottom: 1px solid #222; overflow: hidden; }
        .jam-section { text-align: center; padding-top: 6px; }
        .jam-digital { font-family: 'Orbitron', sans-serif; font-size: 26px; font-weight: 900; color: #00ff00; letter-spacing: 2px; line-height: 1; text-shadow: 0 0 10px rgba(0, 255, 0, 0.6); }
        .tanggal-digital { font-size: 9px; font-weight: 700; color: #ffffff; letter-spacing: 1px; margin-top: 5px; text-transform: uppercase; }

        .bg-atas { position: fixed; top: 0; left: 0; width: 100%; height: 350px; background: linear-gradient(135deg, #004d00 0%, #008000 100%); z-index: 1; }
        .container { position: relative; z-index: 2; width: 90%; max-width: 400px; margin-top: 160px; margin-bottom: 40px; }

        .card { background: rgba(255, 255, 255, 0.98); border-radius: 25px; padding: 75px 20px 30px 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); text-align: center; position: relative; }

        .foto-lingkaran { 
            position: absolute; top: -55px; left: 50%; transform: translateX(-50%); 
            width: 110px; height: 110px; border: 5px solid #fff; border-radius: 50%; 
            background: #eee; display: flex; align-items: center; justify-content: center; 
            overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.2); 
            outline: 2px solid #008000; cursor: pointer; z-index: 5; 
        }
        .foto-lingkaran img { width: 100%; height: 100%; object-fit: cover; display: none; position: absolute; z-index: 10; }
        .foto-lingkaran span { font-size: 10px; font-weight: 800; color: #777; z-index: 1; }
        
        /* FIX JUDUL SATU BARIS */
        .judul-besar { 
            color: #008000; 
            font-weight: 800; 
            font-size: clamp(14px, 4.5vw, 18px); 
            margin-bottom: 5px; 
            white-space: nowrap; 
            overflow: hidden;
        }
        .t-hitam { color: #1a1a1a; font-weight: 800; font-size: 17px; margin-bottom: 25px; }

        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; font-size: 14px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; color: #fff; margin-bottom: 8px; }
        .btn-masuk { background: #008000; }
        .btn-pulang { background: #0056b3; }
        .btn-wa { background: #25D366; font-size: 12px; margin-top: 10px; }
        
        .rekap-box { margin-top: 15px; padding: 15px; background: #f1f3f5; border-radius: 15px; border: 1px solid #ddd; text-align: left; }
        .hidden { display: none !important; }
        
        #layar-kamera, #crop-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10001; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #img-crop { max-width: 90%; max-height: 70%; }
        
        /* STYLE RIWAYAT DENGAN FOTO */
        .log-item { display: flex; gap: 10px; border-bottom: 1px solid #eee; padding: 10px 0; align-items: center; }
        .log-img { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd; }
        .log-text { flex: 1; font-size: 10px; line-height: 1.3; }
        
        /* TOMBOL GANTI KAMERA */
        #btn-switch { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.3); color: #fff; padding: 10px; border-radius: 50%; width: 45px; height: 45px; font-size: 20px; display: flex; align-items: center; justify-content: center; border: 1px solid #fff; }
    </style>
</head>
<body>

<div class="masjid-header">
    <div class="running-text">
        <marquee scrollamount="6">+++ ABSENSI BUMDES AMANAH MANDIRI JAYA 2026 DESA PAJAMBON +++</marquee>
    </div>
    <div class="jam-section">
        <div class="jam-digital" id="jam-running">00:00:00</div>
        <div class="tanggal-digital" id="tgl-hari-ini">...</div>
    </div>
</div>

<div class="bg-atas"></div>
<div class="container">
    <div class="card" id="hal-login">
        <div class="foto-lingkaran" onclick="pilihFile('logo')">
            <img id="v-logo-l">
            <span id="s-logo-l">UPLOAD LOGO</span>
        </div>
        <div class="judul-besar">BUMDES AMANAH MANDIRI JAYA</div>
        <div class="t-hitam">DESA PAJAMBON</div>
        <input type="text" id="in-user" placeholder="Nama / No.Handphone">
        <input type="password" id="in-pass" placeholder="Sandi">
        <button class="btn btn-masuk" onclick="prosesLogin()">MASUK</button>
        <p style="font-size:13px">Belum daftar? <span style="color:#008000; font-weight:800; cursor:pointer" onclick="pindah('hal-reg')">DAFTAR</span></p>
    </div>

    <div class="card hidden" id="hal-reg">
        <div class="foto-lingkaran"><img id="v-logo-r"><span id="s-logo-r">LOGO</span></div>
        <div class="judul-besar">PENDAFTARAN</div>
        <input type="text" id="r-nama" placeholder="Nama Lengkap">
        <input type="tel" id="r-hp" placeholder="No.Handphone">
        <select id="r-jab"><option>Ketua</option><option>Sekertaris</option><option>Bendahara</option><option>Unit</option><option>Anggota</option></select>
        <input type="password" id="r-p1" placeholder="Sandi">
        <input type="password" id="r-p2" placeholder="Ulangi Sandi">
        <button class="btn btn-masuk" onclick="prosesDaftar()">SIMPAN</button>
        <p onclick="pindah('hal-login')" style="cursor:pointer; color:#008000; font-weight:800">KEMBALI</p>
    </div>

    <div class="card hidden" id="hal-dash">
        <div class="foto-lingkaran" onclick="pilihFile('profil')"><img id="v-prof"><span id="s-prof">FOTO</span></div>
        <div class="judul-besar" id="user-nama">...</div>
        <div class="t-hitam" id="user-jab">...</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <button class="btn btn-masuk" onclick="mulaiAbsen('MASUK')">MASUK</button>
            <button class="btn btn-pulang" onclick="mulaiAbsen('PULANG')">PULANG</button>
        </div>
        <button class="btn" style="background:red; font-size:12px; padding:10px" onclick="prosesIzin()">IZIN / SAKIT</button>
        
        <div class="rekap-box">
            <div style="font-size:11px; font-weight:800; margin-bottom:8px">Filter Rekap</div>
            <div style="display:flex; gap:5px">
                <input type="date" id="tgl-mulai" style="font-size:10px">
                <input type="date" id="tgl-akhir" style="font-size:10px">
            </div>
            <button class="btn" style="background:#444; padding:8px; font-size:11px" onclick="filterRekap()">TAMPILKAN</button>
            <div id="list-log"></div>
            <button class="btn btn-wa" id="btn-bagikan" style="display:none" onclick="bagikanKeWA()">KIRIM KE WA</button>
        </div>
        <p onclick="location.reload()" style="color:red; font-size:11px; font-weight:800; margin-top:15px; cursor:pointer">KELUAR</p>
    </div>
</div>

<div id="crop-overlay">
    <div style="flex:1; width:100%; display:flex; align-items:center; justify-content:center; background:#111"><img id="img-crop"></div>
    <div style="display:flex; gap:10px; padding:20px; width:100%; background:#000">
        <button class="btn" style="background:#555; flex:1" onclick="tutupCrop()">BATAL</button>
        <button class="btn btn-masuk" style="flex:1" onclick="selesaiCrop()">SIMPAN</button>
    </div>
</div>

<div id="layar-kamera">
    <div id="btn-switch" onclick="switchKamera()">ðŸ”„</div>
    <video id="video" autoplay playsinline style="width:85%; border-radius:15px; background: #222;"></video>
    <button class="btn btn-masuk" style="width:80%; margin-top:15px" onclick="ambilFoto()">AMBIL FOTO</button>
    <button class="btn" style="background:red; width:80%" onclick="tutupKamera()">BATAL</button>
    <canvas id="canvas-snap" style="display:none"></canvas>
</div>

<input type="file" id="f-file" hidden accept="image/*">

<script>
    let db = JSON.parse(localStorage.getItem('amj_data_v3'));
    let riwayat = JSON.parse(localStorage.getItem('amj_riwayat')) || [];
    let cropper, currentTarget, stream, modeAbsen;
    let currentFacingMode = "user"; // Default depan

    function updateClock() {
        const d = new Date();
        document.getElementById('jam-running').innerText = d.toLocaleTimeString('id-ID');
        document.getElementById('tgl-hari-ini').innerText = d.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric'});
    }
    setInterval(updateClock, 1000); updateClock();

    function pindah(id) {
        document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function pilihFile(t) { currentTarget = t; document.getElementById('f-file').click(); }
    document.getElementById('f-file').onchange = function(e) {
        let reader = new FileReader();
        reader.onload = function(ev) {
            document.getElementById('crop-overlay').style.display='flex';
            document.getElementById('img-crop').src = ev.target.result;
            if(cropper) cropper.destroy();
            cropper = new Cropper(document.getElementById('img-crop'), {aspectRatio:1});
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    function tutupCrop() { document.getElementById('crop-overlay').style.display='none'; }
    function selesaiCrop() {
        let b64 = cropper.getCroppedCanvas().toDataURL('image/jpeg');
        if(currentTarget === 'logo') {
            localStorage.setItem('amj_logo', b64);
            updateImg('logo', b64);
        } else {
            localStorage.setItem('amj_foto_user', b64);
            updateImg('prof', b64);
        }
        tutupCrop();
    }

    function updateImg(type, src) {
        if(type === 'logo') {
            ['v-logo-l', 'v-logo-r'].forEach(id => { let el=document.getElementById(id); if(el){ el.src=src; el.style.display='block'; } });
            ['s-logo-l', 's-logo-r'].forEach(id => { let el=document.getElementById(id); if(el) el.style.display='none'; });
        } else {
            let img=document.getElementById('v-prof'); img.src=src; img.style.display='block';
            document.getElementById('s-prof').style.display='none';
        }
    }

    function prosesDaftar() {
        let n = document.getElementById('r-nama').value, hp = document.getElementById('r-hp').value, p = document.getElementById('r-p1').value, j = document.getElementById('r-jab').value;
        if(!n || p !== document.getElementById('r-p2').value) return alert("Cek data!");
        db = { n: n.toUpperCase(), h: hp, j: j, p: p };
        localStorage.setItem('amj_data_v3', JSON.stringify(db));
        alert("Berhasil!"); pindah('hal-login');
    }

    function prosesLogin() {
        let u = document.getElementById('in-user').value.toUpperCase(), p = document.getElementById('in-pass').value;
        if(db && (u === db.n || u === db.h) && p === db.p) {
            document.getElementById('user-nama').innerText = db.n;
            document.getElementById('user-jab').innerText = db.j;
            filterRekap(); pindah('hal-dash');
        } else alert("Gagal!");
    }

    // FUNGSI KAMERA BARU
    async function mulaiAbsen(m) {
        modeAbsen = m;
        currentFacingMode = "user"; // Reset ke depan dulu
        bukaKamera();
    }

    async function switchKamera() {
        currentFacingMode = (currentFacingMode === "user") ? "environment" : "user";
        if(stream) stream.getTracks().forEach(t=>t.stop());
        bukaKamera();
    }

    async function bukaKamera() {
        document.getElementById('layar-kamera').style.display='flex';
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: currentFacingMode }
            });
            document.getElementById('video').srcObject = stream;
        } catch(e) { alert("Gagal akses kamera!"); }
    }

    function tutupKamera() { if(stream) stream.getTracks().forEach(t=>t.stop()); document.getElementById('layar-kamera').style.display='none'; }
    
    function ambilFoto() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas-snap');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const fotoAbsen = canvas.toDataURL('image/jpeg', 0.5); // Perkecil ukuran foto

        tutupKamera();
        navigator.geolocation.getCurrentPosition(async pos => {
            let lat = pos.coords.latitude, lon = pos.coords.longitude;
            let lok = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
            try {
                let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                let data = await res.json(); 
                lok = data.address.village || data.address.suburb || data.address.city || lok;
            } catch(e) {}
            addLog(modeAbsen, lok, fotoAbsen);
        }, () => addLog(modeAbsen, "Lokasi tidak aktif", fotoAbsen));
    }

    function prosesIzin() {
        let t = prompt("Alasan Izin:");
        if(t) addLog("IZIN", "Alasan: "+t, null);
    }

    function addLog(tipe, ket, foto) {
        let time = new Date();
        riwayat.unshift({ 
            tgl: time.toISOString().split('T')[0], 
            jam: time.toLocaleTimeString('id-ID'), 
            tipe, 
            ket, 
            foto 
        });
        localStorage.setItem('amj_riwayat', JSON.stringify(riwayat));
        filterRekap(); alert("Tercatat!");
    }

    function filterRekap() {
        let m = document.getElementById('tgl-mulai').value, a = document.getElementById('tgl-akhir').value;
        let filtered = riwayat;
        if(m && a) filtered = riwayat.filter(r => r.tgl >= m && r.tgl <= a);
        
        let html = filtered.slice(0,10).map(r => `
            <div class="log-item">
                <input type="checkbox" class="log-sel" value="${r.tipe} (${r.jam}) - ${r.ket}">
                ${r.foto ? `<img src="${r.foto}" class="log-img">` : `<div class="log-img" style="background:#ddd; display:flex; align-items:center; justify-content:center; font-size:8px">No Foto</div>`}
                <div class="log-text">
                    <b>${r.tipe}</b> | ${r.jam}<br>
                    <span>${r.ket}</span>
                </div>
            </div>
        `).join('');
        document.getElementById('list-log').innerHTML = html || "<p style='font-size:10px;text-align:center'>Belum ada data</p>";
        document.getElementById('btn-bagikan').style.display = filtered.length ? 'block' : 'none';
    }

    function bagikanKeWA() {
        let items = Array.from(document.querySelectorAll('.log-sel:checked')).map(el => el.value);
        if(!items.length) return alert("Pilih data dulu!");
        let teks = `*REKAP ABSENSI BUMDES AMJ*\nNama: ${db.n}\n\n` + items.join('\n\n');
        window.open(`https://wa.me/?text=${encodeURIComponent(teks)}`);
    }

    window.onload = () => {
        let l = localStorage.getItem('amj_logo'), p = localStorage.getItem('amj_foto_user');
        if(l) updateImg('logo', l);
        if(p) updateImg('prof', p);
    };
</script>
</body>
</html>
